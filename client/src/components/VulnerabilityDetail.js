import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  Box,
  Typography,
  Paper,
  Button,
  List,
  ListItem,
  ListItemText,
  Divider,
} from '@mui/material';
import EditIcon from '@mui/icons-material/Edit';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import axios from 'axios';

function VulnerabilityDetail() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [vulnerability, setVulnerability] = useState(null);

  useEffect(() => {
    fetchVulnerability();
  }, [id]);

  const fetchVulnerability = async () => {
    try {
      const response = await axios.get(`http://localhost:3001/api/vulnerabilities/${id}`);
      setVulnerability(response.data);
    } catch (error) {
      console.error('Error fetching vulnerability:', error);
    }
  };

  if (!vulnerability) {
    return <Typography>Loading...</Typography>;
  }

  const { data } = vulnerability;

  return (
    <Box>
      <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 2 }}>
        <Button
          startIcon={<ArrowBackIcon />}
          onClick={() => navigate('/')}
        >
          Back to List
        </Button>
        <Button
          variant="contained"
          startIcon={<EditIcon />}
          onClick={() => navigate(`/vulnerabilities/${id}/edit`)}
        >
          Edit
        </Button>
      </Box>

      <Paper sx={{ p: 3 }}>
        <Typography variant="h4" gutterBottom>
          {data.summary}
        </Typography>

        <List>
          <ListItem>
            <ListItemText
              primary="ID"
              secondary={vulnerability.id}
            />
          </ListItem>
          <Divider />
          <ListItem>
            <ListItemText
              primary="Details"
              secondary={data.details}
            />
          </ListItem>
          <Divider />
          <ListItem>
            <ListItemText
              primary="Affected Packages"
              secondary={data.affected?.map(pkg => `${pkg.package.name} (${pkg.package.ecosystem})`).join(', ')}
            />
          </ListItem>
          <Divider />
          <ListItem>
            <ListItemText
              primary="References"
              secondary={data.references?.map(ref => ref.url).join('\n')}
            />
          </ListItem>
          <Divider />
          <ListItem>
            <ListItemText
              primary="Created At"
              secondary={new Date(vulnerability.created_at).toLocaleString()}
            />
          </ListItem>
          <ListItem>
            <ListItemText
              primary="Last Updated"
              secondary={new Date(vulnerability.updated_at).toLocaleString()}
            />
          </ListItem>
        </List>
      </Paper>
    </Box>
  );
}

export default VulnerabilityDetail; 